// Copyright (c) 2024 IBM Corporation and others.
// Licensed under Creative Commons Attribution-NoDerivatives
// 4.0 International (CC BY-ND 4.0)
//   https://creativecommons.org/licenses/by-nd/4.0/
//
// Contributors:
//   IBM Corporation
:projectid: jms-intro
:page-layout: guide-multipane
:page-duration: 30 minutes
:page-releasedate: 2024-08-29
:page-description: Learn how to produce and consume messages in Java microservices by using Jakarta Messaging with Liberty Messaging Server, Liberty Messaging Server Client, and IBM MQ.
:page-tags: ['jakarta-ee']
:page-permalink: /guides/{projectid}
:imagesdir: /img/guide/{projectid}
:page-related-guides: ['jakarta-websocket']
:common-includes: https://raw.githubusercontent.com/OpenLiberty/guides-common/prod
:source-highlighter: prettify
:page-seo-title: Producing and consuming messages in Java microservices by using Jakarta Messaging
:page-seo-description: A getting started tutorial with examples on how to produce and consume messages in Java microservices by using Jakarta Messaging with Liberty Messaging Server, Liberty Messaging Server Client, and IBM MQ.
= Producing and consuming messages in Java microservices


[.hidden]
NOTE: This repository contains the guide documentation source. To view the guide in published form, view it on the https://openliberty.io/guides/{projectid}.html[Open Liberty website].

Learn how to produce and consume messages in Java microservices by using Jakarta Messaging with Liberty Messaging Server, Liberty Messaging Server Client, and IBM MQ.

== What you'll learn
You will learn how to communicate Java services by using Jakarta Messaging with Liberty Messaging Server, Liberty Messaging Server Client, and IBM MQ. You will use a Jakarta Messaging system to handle the asynchronous messages that are sent and received between the microservices as streams of events.

You'll also explore the configuration and use of Liberty Messaging Server, along with examples of message production and consumption with Liberty Messaging Server Client. Additionally, you will discover how to integrate Liberty Messaging Server with IBM MQ.

In this guide, you will use Jakarta Messaging APIs to build the application and implement a messaging solution that enables communication between different parts of Java microservices. Jakarta Messaging makes it easy to write and configure your application to send, receive, and process the events efficiently.

*What is Jakarta Messaging?*

Jakarta Messaging provides an easy way to asynchronously send, receive, and process messages that are received as continuous streams of events. By integrating Jakarta Messaging with Open Liberty, you can easily configure and manage message producers and consumers within your Java microservices. You simply use the Jakarta Messaging API to annotate methods in your application beans, and Open Liberty handles the communication infrastructure, ensuring messages are reliably exchanged. This integration allows your services to connect easily with external messaging systems, such as IBM MQ.

The application in this guide consists of two microservices, `system` and `inventory`. Every 15 seconds, the `system` microservice calculates and publishes an event that contains its current average system load. The `inventory` microservice subscribes to that information so that it can keep an updated list of all the systems and their current system loads. The current inventory of systems can be accessed via the `/systems` REST endpoint. You'll create the `system` and `inventory` microservices using Java Message System.

image::architecture.png[Application architecture where system and inventory services use the Jakarta Messaging to communicate.,align="center"]

== Additional prerequisites
* If you won't be working on the *Using IBM MQ* section, you donâ€™t need to run Docker and you can skip this part.
* IBM MQ container is required to run if you are using Linux.

Before you begin, you need to install Docker if it is not already installed. For installation instructions, refer to the https://docs.docker.com/get-docker/[official Docker documentation^]. You will build and run the application in Docker containers.

Make sure to start your Docker daemon before you proceed.
// =================================================================================================
// Getting started
// =================================================================================================
[role='command']
include::{common-includes}/gitclone.adoc[]
// =================================================================================================
// Try what you'll build
// =================================================================================================

=== Try what you'll build

The `finish` directory in the root of this guide contains the finished application. Give it a try before you proceed.

To try out the application, first go to the `finish` directory and run the following Maven goal to build and install the `models` module.
```
cd finish
mvn -pl models clean install
```

Start the `inventory` service by running the following command:
```
mvn -pl inventory liberty:run
```

Next, open another command-line session, navigate to the `finish` directory, and start the `system` service by using the following command:
```
mvn -pl system liberty:run
```

After you see the following message, your Liberty instances are ready:
[role="no_copy"]
----
The defaultServer server is ready to run a smarter planet.
----

Visit the http://localhost:9085/health[^] URL to confirm that the `inventory` microservice is up and running.

When both the liveness and readiness health checks are up, go to the http://localhost:9085/inventory/systems[^] URL to access the `inventory` microservice. You see the CPU systemLoad property for all the systems:

[source, role='no_copy']
----
{
   "hostname":<your hostname>,
   "systemLoad":2.25927734375
}
----

You can revisit the http://localhost:9085/inventory/systems[^] URL after a while, and you will notice the CPU `systemLoad` property for the systems changed.

You can also use `curl` command to retrieve the hostname and systemLoad information from the `inventory/systems` server endpoint in another command line session:
```
curl http://localhost:9085/inventory/systems
```

After you see the following message in the command-line session, both your services can reach the `inventory/system` server using the curl command.

[role="no_copy"]
----
{
   "hostname": <your hostname>,
   "systemLoad": 2.25927734375
}
----

After you are finished checking out the application, stop the Liberty instance by pressing `CTRL+C` in each command-line sessions where you ran Liberty. Alternatively, you can run the `liberty:stop` goal from the `finish` directory in another shell session:
// stopping dev mode
[role='command']
----
mvn -pl inventory liberty:stop
mvn -pl system liberty:stop
----

== Creating the message producer in the system service 

Navigate to the `start` directory to begin.

The `system` microservice is the producer of the messages that are published to the Jakarta messaging system as a stream of events. Every 15 seconds, the `system` microservice publishes an event that contains its calculation of the average system load (its CPU usage) for the last minute.

[role="code_command hotspot file=0", subs="quotes"]
----
#Create the `SystemService` class.#
`system/src/main/java/io/openliberty/guides/system/SystemService.java`
----

SystemService.java
[source, Java, linenums, role='code_column hide_tags=copyright']
----
include::finish/system/src/main/java/io/openliberty/guides/system/SystemService.java[]
----

* create and explain SystemService class
* replace the server.xml and explain the JMS configration

== Creating the consumer in the inventory microservice

* start the dev mode
* Create and explain InventoryQueueListener class
* replace the server.xml and explain the JMS configration

== Running the application

* similar to the https://openliberty.io/guides/cdi-intro.html#running-the-application

== Testing the inventory application

* similar to https://openliberty.io/guides/cdi-intro.html#testing-the-inventory-application
* explain the test

=== Running the tests

* similar to https://openliberty.io/guides/cdi-intro.html#running-the-tests
* stop the dev mode of the system and inventory services

== Using IBM MQ - Optional

* start IBM MQ on Linux
* replace the server.xml of the system and inventory services
* start dev mode for the system and inventory services
* run the url
* run test on inventory dev mode
* tear down to stop IBM MQ and dev mode
